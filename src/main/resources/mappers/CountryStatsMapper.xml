<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qualco.countries.mapper.CountryStatsMapper">
    <select id="findMaxGdpPerPopulation" resultType="com.qualco.countries.dto.CountryStatsMaxGdpRatioDto">
        SELECT
            c.name,
            c.country_code3 AS countryCode3,
            cs.year,
            cs.population,
            cs.gdp
        FROM
            countries c
        INNER JOIN (
            SELECT
                cs.*,
                ROW_NUMBER() OVER (
                    PARTITION BY cs.country_id
                    ORDER BY cs.gdp / cs.population DESC
                    ) AS rnk
            FROM
                country_stats cs
            WHERE
                cs.population > 0
            ) AS cs ON cs.country_id = c.country_id
        WHERE
            cs.rnk = 1;
    </select>

    <select id="findCountryStats" resultType="com.qualco.countries.dto.CountryStatsViewDto">
        SELECT
            co.name AS continentName,
            r.region_id AS regionId,
            r.name  AS regionName,
            c.name  AS countryName,
            cs.year,
            cs.population,
            cs.gdp
        FROM
            continents co
        INNER JOIN
            regions r ON r.continent_id = co.continent_id
        INNER JOIN
            countries c ON c.region_id = r.region_id
        INNER JOIN
            country_stats cs ON cs.country_id = c.country_id
        WHERE
            (#{regionId} IS NULL OR r.region_id = #{regionId}) AND
            (#{yearFrom} IS NULL OR cs.year >= #{yearFrom}) AND
            (#{yearTo} IS NULL OR cs.year &lt;= #{yearTo})
        ORDER BY
            co.name, r.name, c.name, cs.year
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countCountryStats" resultType="int">
        SELECT
            COUNT(*)
        FROM
            continents co
        INNER JOIN
            regions r ON r.continent_id = co.continent_id
        INNER JOIN
            countries c ON c.region_id = r.region_id
        INNER JOIN
            country_stats cs ON cs.country_id = c.country_id
        WHERE
            (#{regionId} IS NULL OR r.region_id = #{regionId}) AND
            (#{yearFrom} IS NULL OR cs.year >= #{yearFrom}) AND
            (#{yearTo} IS NULL OR cs.year &lt;= #{yearTo})
    </select>

</mapper>
